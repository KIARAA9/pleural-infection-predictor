<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="3-Month Survival Prediction Model for Thoracic Infection based on Cox Proportional Hazards Regression">
    <meta name="keywords" content="thoracic infection, survival prediction, prognostic model, Cox regression">
    <meta name="author" content="Clinical Research Team">
    <meta property="og:title" content="Thoracic Infection Survival Predictor">
    <meta property="og:description" content="Calculate 3-month survival probability for patients with thoracic infection">
    <meta property="og:type" content="website">
    <title>3-Month Survival Predictor | Thoracic Infection Prognostic Model</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            min-height: 100vh;
            background: linear-gradient(135deg, #F0F9FF 0%, #E0F2FE 50%, #F0FDFA 100%);
            font-family: 'DM Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            position: relative;
            overflow-x: hidden;
            -webkit-font-smoothing: antialiased;
        }

        .bg-gradient {
            position: fixed;
            top: 0;
            right: 0;
            width: 60%;
            height: 60%;
            background: radial-gradient(circle at top right, rgba(14, 165, 233, 0.08), transparent 60%);
            pointer-events: none;
            z-index: 0;
        }

        .bg-pattern {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 40%;
            height: 40%;
            background: radial-gradient(circle at bottom left, rgba(20, 184, 166, 0.06), transparent 50%);
            pointer-events: none;
            z-index: 0;
        }

        header {
            padding: 24px 20px;
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(14, 165, 233, 0.1);
            position: relative;
            z-index: 10;
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: 14px;
            max-width: 1200px;
            margin: 0 auto;
        }

        .logo-icon {
            width: 50px;
            height: 50px;
            min-width: 50px;
            background: linear-gradient(135deg, #0EA5E9 0%, #14B8A6 100%);
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            box-shadow: 0 4px 14px rgba(14, 165, 233, 0.3);
        }

        .title {
            font-size: 22px;
            font-weight: 700;
            color: #0F172A;
            letter-spacing: -0.02em;
            line-height: 1.2;
        }

        .subtitle {
            font-size: 13px;
            color: #64748B;
            margin-top: 4px;
            font-weight: 500;
        }

        main {
            max-width: 1200px;
            margin: 0 auto;
            padding: 24px 20px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
            position: relative;
            z-index: 10;
        }

        @media (max-width: 900px) {
            main {
                grid-template-columns: 1fr;
                padding: 16px;
                gap: 20px;
            }
            header {
                padding: 16px;
            }
            .title {
                font-size: 18px;
            }
            .subtitle {
                font-size: 12px;
            }
            .logo-icon {
                width: 44px;
                height: 44px;
                min-width: 44px;
                border-radius: 12px;
            }
            .logo-icon svg {
                width: 24px;
                height: 24px;
            }
        }

        .card {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 24px;
            box-shadow: 0 4px 24px rgba(0, 0, 0, 0.06), 0 1px 2px rgba(0, 0, 0, 0.04);
            border: 1px solid rgba(255, 255, 255, 0.8);
            animation: fadeIn 0.5s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(16px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .card-title {
            font-size: 18px;
            font-weight: 700;
            color: #0F172A;
            margin-bottom: 6px;
        }

        .card-desc {
            font-size: 13px;
            color: #64748B;
            margin-bottom: 24px;
        }

        .form-grid {
            display: grid;
            gap: 20px;
        }

        .input-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .label {
            display: flex;
            justify-content: space-between;
            align-items: baseline;
        }

        .label-text {
            font-size: 14px;
            font-weight: 600;
            color: #334155;
        }

        .label-unit {
            font-size: 12px;
            color: #94A3B8;
            font-weight: 500;
        }

        input[type="number"] {
            padding: 14px 16px;
            font-size: 16px;
            border: 2px solid #E2E8F0;
            border-radius: 12px;
            outline: none;
            transition: all 0.2s ease;
            background: rgba(255, 255, 255, 0.9);
            color: #0F172A;
            font-family: inherit;
            -webkit-appearance: none;
            -moz-appearance: textfield;
        }

        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        input[type="number"]:focus {
            border-color: #0EA5E9;
            box-shadow: 0 0 0 4px rgba(14, 165, 233, 0.1);
        }

        input[type="number"].error {
            border-color: #EF4444;
            background: #FEF2F2;
        }

        .error-text {
            font-size: 12px;
            color: #EF4444;
            font-weight: 500;
            display: none;
        }

        .error-text.show {
            display: block;
        }

        .radio-group {
            display: flex;
            gap: 10px;
        }

        @media (max-width: 400px) {
            .radio-group {
                flex-direction: column;
            }
        }

        .radio-label {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 14px 14px;
            border: 2px solid #E2E8F0;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 13px;
            font-weight: 500;
            color: #475569;
            background: rgba(255, 255, 255, 0.9);
            -webkit-tap-highlight-color: transparent;
        }

        .radio-label:hover {
            border-color: #CBD5E1;
        }

        .radio-label.active {
            border-color: #0EA5E9;
            background: rgba(14, 165, 233, 0.05);
            color: #0EA5E9;
        }

        .radio-label input {
            display: none;
        }

        .radio-custom {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            border: 2px solid currentColor;
            position: relative;
            flex-shrink: 0;
        }

        .radio-label.active .radio-custom::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 8px;
            height: 8px;
            background: currentColor;
            border-radius: 50%;
        }

        .button-group {
            display: flex;
            gap: 12px;
            margin-top: 28px;
        }

        .btn-primary {
            flex: 2;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 16px 24px;
            font-size: 15px;
            font-weight: 600;
            color: white;
            background: linear-gradient(135deg, #0EA5E9 0%, #0284C7 100%);
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 4px 14px rgba(14, 165, 233, 0.35);
            font-family: inherit;
            -webkit-tap-highlight-color: transparent;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(14, 165, 233, 0.4);
        }

        .btn-primary:active {
            transform: translateY(0);
        }

        .btn-secondary {
            flex: 1;
            padding: 16px 20px;
            font-size: 15px;
            font-weight: 600;
            color: #64748B;
            background: transparent;
            border: 2px solid #E2E8F0;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-family: inherit;
            -webkit-tap-highlight-color: transparent;
        }

        .btn-secondary:hover {
            border-color: #CBD5E1;
            background: rgba(241, 245, 249, 0.5);
        }

        /* Results Card */
        .result-card {
            display: none;
        }

        .result-card.show {
            display: block;
            animation: fadeIn 0.5s ease-out;
        }

        .result-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 12px;
        }

        .risk-badge {
            padding: 8px 14px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 700;
            border: 2px solid;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            white-space: nowrap;
        }

        .result-main {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }

        .survival-display {
            text-align: center;
        }

        .survival-circle {
            position: relative;
            width: 160px;
            height: 160px;
            margin: 0 auto;
        }

        @media (max-width: 400px) {
            .survival-circle {
                width: 140px;
                height: 140px;
            }
            .survival-number {
                font-size: 40px !important;
            }
            .survival-percent {
                font-size: 20px !important;
            }
        }

        .progress-ring {
            width: 100%;
            height: 100%;
            transform: rotate(-90deg);
        }

        .progress-ring-bg {
            fill: none;
            stroke: #E5E7EB;
            stroke-width: 8;
        }

        .progress-ring-fill {
            fill: none;
            stroke-width: 8;
            stroke-linecap: round;
            stroke-dasharray: 283;
            stroke-dashoffset: 283;
            transition: stroke-dashoffset 1s ease-out, stroke 0.3s ease;
        }

        .survival-value {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
        }

        .survival-number {
            font-size: 44px;
            font-weight: 800;
            line-height: 1;
            letter-spacing: -0.02em;
        }

        .survival-percent {
            font-size: 22px;
            font-weight: 600;
            color: #94A3B8;
        }

        .survival-label {
            margin-top: 10px;
            font-size: 13px;
            color: #64748B;
            font-weight: 500;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            width: 100%;
        }

        .stat-item {
            text-align: center;
            padding: 14px 12px;
            background: rgba(241, 245, 249, 0.6);
            border-radius: 12px;
        }

        .stat-value {
            display: block;
            font-size: 22px;
            font-weight: 700;
            color: #0F172A;
            margin-bottom: 4px;
        }

        .stat-label {
            font-size: 11px;
            color: #64748B;
            font-weight: 500;
        }

        .interpretation {
            margin-top: 20px;
            padding: 16px;
            background: linear-gradient(135deg, rgba(14, 165, 233, 0.05), rgba(20, 184, 166, 0.05));
            border-radius: 12px;
            border-left: 4px solid #0EA5E9;
        }

        .interpret-title {
            font-size: 13px;
            font-weight: 700;
            color: #0F172A;
            margin-bottom: 8px;
        }

        .interpret-text {
            font-size: 13px;
            color: #475569;
            line-height: 1.6;
        }

        /* Model Info */
        .model-info {
            margin-top: 20px;
            padding: 14px 16px;
            background: rgba(241, 245, 249, 0.5);
            border-radius: 12px;
            border: 1px solid #E2E8F0;
        }

        .model-info-title {
            font-size: 12px;
            font-weight: 700;
            color: #64748B;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .model-formula {
            font-family: 'Monaco', 'Consolas', 'Courier New', monospace;
            font-size: 11px;
            color: #475569;
            line-height: 1.8;
            background: white;
            padding: 10px 12px;
            border-radius: 8px;
            overflow-x: auto;
            white-space: nowrap;
        }

        .model-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 10px;
        }

        .model-stat {
            text-align: center;
            padding: 8px 6px;
            background: white;
            border-radius: 8px;
        }

        .model-stat-value {
            font-size: 15px;
            font-weight: 700;
            color: #0F172A;
        }

        .model-stat-label {
            font-size: 10px;
            color: #94A3B8;
        }

        footer {
            padding: 24px 20px;
            text-align: center;
            position: relative;
            z-index: 10;
        }

        .disclaimer {
            font-size: 12px;
            color: #64748B;
            margin-bottom: 8px;
            line-height: 1.6;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
        }

        .footer-note {
            font-size: 11px;
            color: #94A3B8;
        }

        /* Loading animation */
        .btn-primary.loading {
            pointer-events: none;
            opacity: 0.8;
        }

        .btn-primary.loading::after {
            content: '';
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255,255,255,0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-left: 8px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="bg-gradient"></div>
    <div class="bg-pattern"></div>

    <header>
        <div class="logo-section">
            <div class="logo-icon">
                <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M22 12h-4l-3 9L9 3l-3 9H2"/>
                </svg>
            </div>
            <div>
                <h1 class="title">Thoracic Infection Prognostic Model</h1>
                <p class="subtitle">3-Month Survival Prediction ‚Ä¢ Cox Proportional Hazards</p>
            </div>
        </div>
    </header>

    <main>
        <!-- Input Card -->
        <div class="card">
            <h2 class="card-title">Patient Parameters</h2>
            <p class="card-desc">Enter clinical values to calculate predicted survival probability</p>

            <div class="form-grid">
                <!-- Age -->
                <div class="input-group">
                    <label class="label">
                        <span class="label-text">Age</span>
                        <span class="label-unit">years</span>
                    </label>
                    <input type="number" id="age" placeholder="e.g., 65" min="18" max="120" inputmode="numeric">
                    <span class="error-text" id="age-error">Please enter age between 18-120 years</span>
                </div>

                <!-- Urea -->
                <div class="input-group">
                    <label class="label">
                        <span class="label-text">Blood Urea</span>
                        <span class="label-unit">mmol/L</span>
                    </label>
                    <input type="number" id="urea" placeholder="e.g., 8.5" step="0.1" min="0" max="100" inputmode="decimal">
                    <span class="error-text" id="urea-error">Please enter value between 0-100 mmol/L</span>
                </div>

                <!-- Albumin -->
                <div class="input-group">
                    <label class="label">
                        <span class="label-text">Serum Albumin</span>
                        <span class="label-unit">g/L</span>
                    </label>
                    <input type="number" id="albumin" placeholder="e.g., 35" step="0.1" min="10" max="60" inputmode="decimal">
                    <span class="error-text" id="albumin-error">Please enter value between 10-60 g/L</span>
                </div>

                <!-- Infection Source -->
                <div class="input-group">
                    <label class="label">
                        <span class="label-text">Infection Source</span>
                    </label>
                    <div class="radio-group">
                        <label class="radio-label active" id="label-community">
                            <input type="radio" name="infection" value="community" checked>
                            <span class="radio-custom"></span>
                            <span>Community-acquired</span>
                        </label>
                        <label class="radio-label" id="label-hospital">
                            <input type="radio" name="infection" value="hospital">
                            <span class="radio-custom"></span>
                            <span>Hospital-acquired</span>
                        </label>
                    </div>
                </div>
            </div>

            <div class="button-group">
                <button class="btn-primary" id="calcBtn" onclick="calculateSurvival()">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/>
                        <path d="M12 6v6l4 2"/>
                    </svg>
                    Calculate Survival
                </button>
                <button class="btn-secondary" onclick="resetForm()">Reset</button>
            </div>

            <!-- Model Info -->
            <div class="model-info">
                <div class="model-info-title">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/>
                        <path d="M12 16v-4M12 8h.01"/>
                    </svg>
                    Model Information
                </div>
                <div class="model-formula">
                    LP = 0.0583√óAge + 0.0392√óUrea ‚àí 0.0513√óAlb + 0.6729√óHAI<br>
                    S(3) = 0.886<sup>exp(LP ‚àí LP<sub>mean</sub>)</sup>
                </div>
                <div class="model-stats">
                    <div class="model-stat">
                        <div class="model-stat-value">1,344</div>
                        <div class="model-stat-label">Patients</div>
                    </div>
                    <div class="model-stat">
                        <div class="model-stat-value">153</div>
                        <div class="model-stat-label">Events</div>
                    </div>
                    <div class="model-stat">
                        <div class="model-stat-value">0.820</div>
                        <div class="model-stat-label">C-index</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Results Card -->
        <div class="card result-card" id="result-card">
            <div class="result-header">
                <h2 class="card-title">Prediction Results</h2>
                <div class="risk-badge" id="risk-badge">Good Prognosis</div>
            </div>

            <div class="result-main">
                <div class="survival-display">
                    <div class="survival-circle">
                        <svg class="progress-ring" viewBox="0 0 100 100">
                            <circle class="progress-ring-bg" cx="50" cy="50" r="45"/>
                            <circle class="progress-ring-fill" id="progress-fill" cx="50" cy="50" r="45"/>
                        </svg>
                        <div class="survival-value">
                            <span class="survival-number" id="survival-number">0.0</span>
                            <span class="survival-percent">%</span>
                        </div>
                    </div>
                    <p class="survival-label">3-Month Survival Probability</p>
                </div>

                <div class="stats-grid">
                    <div class="stat-item">
                        <span class="stat-value" id="mortality-prob">0.0%</span>
                        <span class="stat-label">Mortality Risk</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-value" id="linear-predictor">0.000</span>
                        <span class="stat-label">Linear Predictor</span>
                    </div>
                </div>
            </div>

            <div class="interpretation">
                <h3 class="interpret-title">Clinical Interpretation</h3>
                <p class="interpret-text" id="interpret-text">
                    Based on the Cox proportional hazards model...
                </p>
            </div>
        </div>
    </main>

    <footer>
        <p class="disclaimer">
            <strong>Disclaimer:</strong> This tool is intended for research and educational purposes only. 
            Clinical decisions should be made by qualified healthcare professionals.
        </p>
        <p class="footer-note">
            Multicenter Cohort Study (n=1,344) ‚Ä¢ Cox Regression ‚Ä¢ C-index: 0.820
        </p>
    </footer>

    <script>
        // ============================================================
        // Model Coefficients - From Multivariable Cox Regression
        // HR ‚Üí Œ≤: Age 1.06‚Üí0.0583, Urea 1.04‚Üí0.0392, Albumin 0.95‚Üí-0.0513, HAPI 1.96‚Üí0.6729
        // ============================================================
        const MODEL = {
            coef: {
                age: 0.05827,      // ln(1.06)
                urea: 0.03922,     // ln(1.04)
                albumin: -0.05129, // ln(0.95)
                hospital: 0.67294  // ln(1.96)
            },
            // ‚òÖ Mean values of covariates in your cohort
            // ‚òÖ UPDATE these with actual means from your dataset!
            // In R: colMeans(data[, c("Age","Urea","Albumin","Hospital")])
            means: {
                age: 62,
                urea: 8,
                albumin: 33,
                hospital: 0.18
            },
            // Baseline 3-month survival at the MEAN of covariates
            // ‚òÖ UPDATE with actual value from R:
            //   sf <- survfit(cox_model); summary(sf, times=90)$surv
            // Estimated from observed: 1 - 153/1344 ‚âà 0.886
            baselineSurvival: 0.886
        };

        // Radio button handling
        document.querySelectorAll('input[name="infection"]').forEach(radio => {
            radio.addEventListener('change', function() {
                document.querySelectorAll('.radio-label').forEach(label => {
                    label.classList.remove('active');
                });
                this.parentElement.classList.add('active');
            });
        });

        // Validation
        function validateInputs() {
            let isValid = true;
            
            const age = parseFloat(document.getElementById('age').value);
            const urea = parseFloat(document.getElementById('urea').value);
            const albumin = parseFloat(document.getElementById('albumin').value);

            document.querySelectorAll('.error-text').forEach(el => el.classList.remove('show'));
            document.querySelectorAll('input[type="number"]').forEach(el => el.classList.remove('error'));

            if (!age || age < 18 || age > 120) {
                document.getElementById('age-error').classList.add('show');
                document.getElementById('age').classList.add('error');
                isValid = false;
            }

            if (isNaN(urea) || urea < 0 || urea > 100) {
                document.getElementById('urea-error').classList.add('show');
                document.getElementById('urea').classList.add('error');
                isValid = false;
            }

            if (!albumin || albumin < 10 || albumin > 60) {
                document.getElementById('albumin-error').classList.add('show');
                document.getElementById('albumin').classList.add('error');
                isValid = false;
            }

            return isValid;
        }

        // Main calculation
        function calculateSurvival() {
            if (!validateInputs()) return;
            
            const age = parseFloat(document.getElementById('age').value);
            const urea = parseFloat(document.getElementById('urea').value);
            const albumin = parseFloat(document.getElementById('albumin').value);
            const isHospital = document.querySelector('input[name="infection"]:checked').value === 'hospital' ? 1 : 0;

            // LP = Œ≤1*Age + Œ≤2*Urea + Œ≤3*Albumin + Œ≤4*Hospital
            const lp = MODEL.coef.age * age + 
                       MODEL.coef.urea * urea + 
                       MODEL.coef.albumin * albumin + 
                       MODEL.coef.hospital * isHospital;

            // LP at the mean of covariates (for centering)
            const lpMean = MODEL.coef.age * MODEL.means.age +
                           MODEL.coef.urea * MODEL.means.urea +
                           MODEL.coef.albumin * MODEL.means.albumin +
                           MODEL.coef.hospital * MODEL.means.hospital;

            // Centered LP: difference from the average patient
            const lpCentered = lp - lpMean;

            // S(t|X) = S0(t)^exp(LP - LP_mean)
            // where S0(t) is baseline survival at the mean of covariates
            const survivalProb = Math.pow(MODEL.baselineSurvival, Math.exp(lpCentered));
            const mortalityProb = 1 - survivalProb;

            // Determine prognosis level
            let prognosisLevel, prognosisColor;
            if (survivalProb >= 0.9) {
                prognosisLevel = 'Good Prognosis';
                prognosisColor = '#10B981';
            } else if (survivalProb >= 0.7) {
                prognosisLevel = 'Moderate Prognosis';
                prognosisColor = '#F59E0B';
            } else if (survivalProb >= 0.5) {
                prognosisLevel = 'Poor Prognosis';
                prognosisColor = '#F97316';
            } else {
                prognosisLevel = 'Very Poor Prognosis';
                prognosisColor = '#EF4444';
            }

            updateResults(survivalProb, mortalityProb, lpCentered, prognosisLevel, prognosisColor);
        }

        function updateResults(survival, mortality, lp, prognosisLevel, prognosisColor) {
            document.getElementById('result-card').classList.add('show');

            const survivalPercent = (survival * 100).toFixed(1);
            document.getElementById('survival-number').textContent = survivalPercent;
            document.getElementById('survival-number').style.color = prognosisColor;

            const progressFill = document.getElementById('progress-fill');
            const circumference = 283;
            const offset = circumference - (survival * circumference);
            progressFill.style.strokeDashoffset = offset;
            progressFill.style.stroke = prognosisColor;

            document.getElementById('mortality-prob').textContent = (mortality * 100).toFixed(1) + '%';
            document.getElementById('linear-predictor').textContent = lp.toFixed(3);

            const badge = document.getElementById('risk-badge');
            badge.textContent = prognosisLevel;
            badge.style.backgroundColor = prognosisColor + '20';
            badge.style.color = prognosisColor;
            badge.style.borderColor = prognosisColor;

            document.getElementById('interpret-text').innerHTML = 
                `Based on the Cox proportional hazards model, this patient has a predicted 
                <strong style="color: ${prognosisColor}">${survivalPercent}%</strong> probability of survival at 3 months, 
                indicating <strong style="color: ${prognosisColor}">${prognosisLevel}</strong>. 
                The corresponding mortality risk is ${(mortality * 100).toFixed(1)}%.`;

            if (window.innerWidth <= 900) {
                setTimeout(() => {
                    document.getElementById('result-card').scrollIntoView({ behavior: 'smooth', block: 'start' });
                }, 100);
            }
        }

        function resetForm() {
            document.getElementById('age').value = '';
            document.getElementById('urea').value = '';
            document.getElementById('albumin').value = '';
            document.querySelector('input[value="community"]').checked = true;
            document.querySelectorAll('.radio-label').forEach(label => label.classList.remove('active'));
            document.getElementById('label-community').classList.add('active');
            
            document.querySelectorAll('.error-text').forEach(el => el.classList.remove('show'));
            document.querySelectorAll('input[type="number"]').forEach(el => el.classList.remove('error'));
            
            document.getElementById('result-card').classList.remove('show');
            document.getElementById('progress-fill').style.strokeDashoffset = 283;
        }

        // Enter key support
        document.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                calculateSurvival();
            }
        });

        // Prevent zoom on input focus (iOS)
        document.querySelectorAll('input[type="number"]').forEach(input => {
            input.addEventListener('focus', function() {
                this.style.fontSize = '16px';
            });
        });
    </script>

    <!-- QR Code Floating Button & Modal -->
    <button class="qr-fab" id="qrFab" onclick="toggleQRModal()" title="Êâ´Á†ÅÊâãÊú∫ËÆøÈóÆ">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="2" y="2" width="8" height="8" rx="1"/>
            <rect x="14" y="2" width="8" height="8" rx="1"/>
            <rect x="2" y="14" width="8" height="8" rx="1"/>
            <rect x="14" y="14" width="4" height="4"/>
            <line x1="22" y1="14" x2="22" y2="18"/>
            <line x1="18" y1="22" x2="22" y2="22"/>
            <line x1="14" y1="22" x2="14" y2="22"/>
        </svg>
    </button>

    <div class="qr-overlay" id="qrOverlay" onclick="toggleQRModal()"></div>
    <div class="qr-modal" id="qrModal">
        <div class="qr-modal-header">
            <h3>üì± Êâ´Á†ÅÊâãÊú∫ËÆøÈóÆ</h3>
            <button class="qr-close" onclick="toggleQRModal()">‚úï</button>
        </div>
        <div class="qr-body">
            <canvas id="qrCanvas"></canvas>
            <p class="qr-url" id="qrUrl"></p>
            <p class="qr-hint">ËØ∑‰ΩøÁî®ÊâãÊú∫ÊëÑÂÉèÂ§¥ÊàñÂæÆ‰ø°Êâ´‰∏ÄÊâ´</p>
            <div class="qr-input-row">
                <input type="text" id="qrInput" class="qr-input" placeholder="ËæìÂÖ•ÈÉ®ÁΩ≤ÂêéÁöÑURLÔºåÂ¶Ç https://example.com">
                <button class="qr-gen-btn" onclick="generateQR()">ÁîüÊàê</button>
            </div>
        </div>
    </div>

    <style>
        .qr-fab {
            position: fixed;
            bottom: 24px;
            right: 24px;
            width: 52px;
            height: 52px;
            border-radius: 16px;
            background: linear-gradient(135deg, #0EA5E9, #0284C7);
            color: white;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 20px rgba(14,165,233,0.4);
            z-index: 1000;
            transition: all 0.2s;
        }
        .qr-fab:hover { transform: translateY(-2px); box-shadow: 0 6px 24px rgba(14,165,233,0.5); }
        .qr-overlay {
            display: none;
            position: fixed; inset: 0;
            background: rgba(0,0,0,0.4);
            backdrop-filter: blur(4px);
            z-index: 1001;
        }
        .qr-overlay.show { display: block; }
        .qr-modal {
            display: none;
            position: fixed;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 20px;
            padding: 24px;
            z-index: 1002;
            box-shadow: 0 20px 60px rgba(0,0,0,0.2);
            min-width: 320px;
            max-width: 90vw;
            animation: fadeIn 0.3s ease;
        }
        .qr-modal.show { display: block; }
        .qr-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        .qr-modal-header h3 { font-size: 16px; color: #0F172A; }
        .qr-close {
            background: none; border: none; font-size: 18px;
            color: #94A3B8; cursor: pointer; padding: 4px;
        }
        .qr-body { text-align: center; }
        .qr-body canvas {
            display: block;
            margin: 0 auto 12px;
            border-radius: 12px;
            border: 8px solid white;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
        }
        .qr-url {
            font-size: 12px; color: #64748B;
            word-break: break-all;
            margin-bottom: 6px;
            max-width: 280px;
            margin-left: auto; margin-right: auto;
        }
        .qr-hint {
            font-size: 12px; color: #94A3B8;
            margin-bottom: 16px;
        }
        .qr-input-row {
            display: flex; gap: 8px;
            margin-top: 8px;
        }
        .qr-input {
            flex: 1;
            padding: 10px 12px;
            border: 2px solid #E2E8F0;
            border-radius: 10px;
            font-size: 13px;
            font-family: inherit;
            outline: none;
            transition: border-color 0.2s;
        }
        .qr-input:focus { border-color: #0EA5E9; }
        .qr-gen-btn {
            padding: 10px 16px;
            background: linear-gradient(135deg, #0EA5E9, #0284C7);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            font-family: inherit;
            white-space: nowrap;
        }
        .qr-gen-btn:hover { opacity: 0.9; }
    </style>

    <script>
    // ============================================================
    // Minimal QR Code Generator (Pure JS, no dependencies)
    // Supports byte mode, error correction level M, versions 1-10
    // ============================================================
    const QRCode = (() => {
        // GF(256) arithmetic for Reed-Solomon
        const EXP = new Uint8Array(256), LOG = new Uint8Array(256);
        let v = 1;
        for (let i = 0; i < 255; i++) { EXP[i] = v; LOG[v] = i; v = (v << 1) ^ (v >= 128 ? 0x11d : 0); }
        EXP[255] = EXP[0];

        function gfMul(a, b) { return a === 0 || b === 0 ? 0 : EXP[(LOG[a] + LOG[b]) % 255]; }

        function rsGenPoly(n) {
            let p = [1];
            for (let i = 0; i < n; i++) {
                const np = new Array(p.length + 1).fill(0);
                for (let j = 0; j < p.length; j++) {
                    np[j] ^= p[j];
                    np[j + 1] ^= gfMul(p[j], EXP[i]);
                }
                p = np;
            }
            return p;
        }

        function rsEncode(data, ecLen) {
            const gen = rsGenPoly(ecLen);
            const msg = new Uint8Array(data.length + ecLen);
            msg.set(data);
            for (let i = 0; i < data.length; i++) {
                const coef = msg[i];
                if (coef !== 0) {
                    for (let j = 0; j < gen.length; j++) {
                        msg[i + j] ^= gfMul(gen[j], coef);
                    }
                }
            }
            return msg.slice(data.length);
        }

        // QR version info: [totalCodewords, ecCodewordsPerBlock, numBlocks]
        // Error correction level M
        const VERSION_INFO = [
            null,
            [26, 10, 1],    // v1
            [44, 16, 1],    // v2
            [70, 26, 1],    // v3
            [100, 18, 2],   // v4
            [134, 24, 2],   // v5
            [172, 16, 4],   // v6
            [196, 18, 4],   // v7
            [242, 22, 4],   // v8 (added 2 blocks for group2 handling)
            [292, 22, 4],   // v9 (simplified - uses 2 groups)
            [346, 26, 4],   // v10 (simplified)
        ];

        // Data capacity in bytes for each version at ECC-M (byte mode)
        const DATA_CAP = [0, 14, 26, 42, 62, 84, 106, 122, 152, 180, 213];

        // Alignment pattern positions
        const ALIGN_POS = [null, [], [6,18], [6,22], [6,26], [6,30], [6,34], [6,22,38], [6,24,42], [6,26,46], [6,28,50]];

        function getVersion(dataLen) {
            for (let v = 1; v <= 10; v++) {
                if (dataLen <= DATA_CAP[v]) return v;
            }
            return -1;
        }

        function encodeData(text, version) {
            const bytes = new TextEncoder().encode(text);
            const vi = VERSION_INFO[version];
            const totalData = vi[0] - vi[1] * vi[2];
            const bits = [];

            // Mode indicator: byte = 0100
            bits.push(0, 1, 0, 0);
            // Character count (8 bits for v1-9, 16 bits for v10+)
            const ccBits = version <= 9 ? 8 : 16;
            for (let i = ccBits - 1; i >= 0; i--) bits.push((bytes.length >> i) & 1);
            // Data
            for (const b of bytes) for (let i = 7; i >= 0; i--) bits.push((b >> i) & 1);
            // Terminator
            for (let i = 0; i < 4 && bits.length < totalData * 8; i++) bits.push(0);
            // Pad to byte boundary
            while (bits.length % 8 !== 0) bits.push(0);
            // Pad bytes
            let pad = 0;
            while (bits.length < totalData * 8) {
                const pb = pad % 2 === 0 ? 0xEC : 0x11;
                for (let i = 7; i >= 0; i--) bits.push((pb >> i) & 1);
                pad++;
            }

            // Convert to bytes
            const dataBytes = new Uint8Array(totalData);
            for (let i = 0; i < totalData; i++) {
                let b = 0;
                for (let j = 0; j < 8; j++) b = (b << 1) | (bits[i * 8 + j] || 0);
                dataBytes[i] = b;
            }
            return dataBytes;
        }

        function interleaveAndEC(dataBytes, version) {
            const vi = VERSION_INFO[version];
            const ecPerBlock = vi[1];
            const numBlocks = vi[2];
            const totalData = dataBytes.length;
            const baseBlockSize = Math.floor(totalData / numBlocks);
            const extraBlocks = totalData % numBlocks;

            const dataBlocks = [], ecBlocks = [];
            let offset = 0;
            for (let i = 0; i < numBlocks; i++) {
                const bSize = baseBlockSize + (i >= numBlocks - extraBlocks ? 1 : 0);
                const block = dataBytes.slice(offset, offset + bSize);
                dataBlocks.push(block);
                ecBlocks.push(rsEncode(block, ecPerBlock));
                offset += bSize;
            }

            // Interleave data
            const result = [];
            const maxDataLen = Math.max(...dataBlocks.map(b => b.length));
            for (let i = 0; i < maxDataLen; i++) {
                for (const b of dataBlocks) if (i < b.length) result.push(b[i]);
            }
            // Interleave EC
            for (let i = 0; i < ecPerBlock; i++) {
                for (const b of ecBlocks) if (i < b.length) result.push(b[i]);
            }
            return result;
        }

        function createMatrix(version) {
            const size = version * 4 + 17;
            const matrix = Array.from({length: size}, () => new Int8Array(size)); // 0=empty, 1=black, -1=white
            const reserved = Array.from({length: size}, () => new Uint8Array(size)); // 1=reserved

            function setModule(r, c, val) {
                if (r >= 0 && r < size && c >= 0 && c < size) {
                    matrix[r][c] = val ? 1 : -1;
                    reserved[r][c] = 1;
                }
            }

            // Finder patterns
            for (const [cr, cc] of [[0, 0], [0, size - 7], [size - 7, 0]]) {
                for (let r = 0; r < 7; r++) for (let c = 0; c < 7; c++) {
                    const isBorder = r === 0 || r === 6 || c === 0 || c === 6;
                    const isInner = r >= 2 && r <= 4 && c >= 2 && c <= 4;
                    setModule(cr + r, cc + c, isBorder || isInner);
                }
                // Separators
                for (let i = 0; i < 8; i++) {
                    if (cr === 0) { setModule(7, cc + Math.min(i, 7), false); setModule(cr + Math.min(i, 7), cc === 0 ? 7 : cc - 1, false); }
                    else { setModule(cr - 1, cc + Math.min(i, 7), false); setModule(cr + Math.min(i, 7), cc + 7, false); }
                }
            }
            // Fix separator corners
            for (let i = 0; i < 8; i++) {
                setModule(7, i, false); setModule(i, 7, false);
                setModule(7, size - 8 + i, false); setModule(i, size - 8, false);
                setModule(size - 8, i, false); setModule(size - 8 + i, 7, false);
            }

            // Alignment patterns
            const aligns = ALIGN_POS[version];
            if (aligns.length > 0) {
                for (const ar of aligns) for (const ac of aligns) {
                    if ((ar < 9 && ac < 9) || (ar < 9 && ac > size - 9) || (ar > size - 9 && ac < 9)) continue;
                    for (let r = -2; r <= 2; r++) for (let c = -2; c <= 2; c++) {
                        setModule(ar + r, ac + c, Math.abs(r) === 2 || Math.abs(c) === 2 || (r === 0 && c === 0));
                    }
                }
            }

            // Timing patterns
            for (let i = 8; i < size - 8; i++) {
                setModule(6, i, i % 2 === 0);
                setModule(i, 6, i % 2 === 0);
            }

            // Dark module
            setModule(size - 8, 8, true);

            // Reserve format info areas
            for (let i = 0; i < 15; i++) {
                // Around top-left finder
                if (i < 6) { reserved[8][i] = 1; reserved[i][8] = 1; }
                else if (i < 8) { reserved[8][i + 1] = 1; reserved[i + 1][8] = 1; }
                else if (i < 9) { reserved[8][size - 15 + i] = 1; reserved[size - 15 + i][8] = 1; }
                else { reserved[8][size - 15 + i] = 1; reserved[size - 15 + i][8] = 1; }
            }

            return { matrix, reserved, size };
        }

        function placeData(matrix, reserved, size, dataBits) {
            let bitIdx = 0;
            let upward = true;
            for (let col = size - 1; col >= 1; col -= 2) {
                if (col === 6) col = 5; // Skip timing column
                const rows = upward ? Array.from({length: size}, (_, i) => size - 1 - i) : Array.from({length: size}, (_, i) => i);
                for (const row of rows) {
                    for (const dc of [0, -1]) {
                        const c = col + dc;
                        if (c < 0 || c >= size || reserved[row][c]) continue;
                        matrix[row][c] = bitIdx < dataBits.length && dataBits[bitIdx] ? 1 : -1;
                        bitIdx++;
                    }
                }
                upward = !upward;
            }
        }

        function applyMask(matrix, reserved, size, maskNum) {
            const maskFn = [
                (r, c) => (r + c) % 2 === 0,
                (r, c) => r % 2 === 0,
                (r, c) => c % 3 === 0,
                (r, c) => (r + c) % 3 === 0,
                (r, c) => (Math.floor(r / 2) + Math.floor(c / 3)) % 2 === 0,
                (r, c) => (r * c) % 2 + (r * c) % 3 === 0,
                (r, c) => ((r * c) % 2 + (r * c) % 3) % 2 === 0,
                (r, c) => ((r + c) % 2 + (r * c) % 3) % 2 === 0,
            ][maskNum];

            for (let r = 0; r < size; r++) {
                for (let c = 0; c < size; c++) {
                    if (!reserved[r][c] && maskFn(r, c)) {
                        matrix[r][c] = matrix[r][c] === 1 ? -1 : 1;
                    }
                }
            }
        }

        // Format info for ECC level M (10) with each mask pattern
        const FORMAT_BITS = [
            0x5412, 0x5125, 0x5E7C, 0x5B4B, 0x45F9, 0x40CE, 0x4F97, 0x4AA0,
        ];

        function placeFormatInfo(matrix, size, maskNum) {
            const bits = FORMAT_BITS[maskNum];
            const positions1 = [[0,8],[1,8],[2,8],[3,8],[4,8],[5,8],[7,8],[8,8],[8,7],[8,5],[8,4],[8,3],[8,2],[8,1],[8,0]];
            const positions2 = [];
            for (let i = 0; i < 7; i++) positions2.push([8, size - 1 - i]);
            for (let i = 0; i < 8; i++) positions2.push([size - 7 + i, 8]);

            for (let i = 0; i < 15; i++) {
                const bit = (bits >> (14 - i)) & 1;
                const [r1, c1] = positions1[i];
                matrix[r1][c1] = bit ? 1 : -1;
                if (i < positions2.length) {
                    const [r2, c2] = positions2[i];
                    matrix[r2][c2] = bit ? 1 : -1;
                }
            }
        }

        function penalty(matrix, size) {
            let score = 0;
            // Rule 1: runs of same color
            for (let r = 0; r < size; r++) {
                let cnt = 1;
                for (let c = 1; c < size; c++) {
                    if (matrix[r][c] === matrix[r][c-1]) { cnt++; } 
                    else { if (cnt >= 5) score += cnt - 2; cnt = 1; }
                }
                if (cnt >= 5) score += cnt - 2;
            }
            for (let c = 0; c < size; c++) {
                let cnt = 1;
                for (let r = 1; r < size; r++) {
                    if (matrix[r][c] === matrix[r-1][c]) { cnt++; }
                    else { if (cnt >= 5) score += cnt - 2; cnt = 1; }
                }
                if (cnt >= 5) score += cnt - 2;
            }
            // Rule 3: finder-like patterns
            for (let r = 0; r < size; r++) {
                for (let c = 0; c < size - 6; c++) {
                    const s = [matrix[r][c],matrix[r][c+1],matrix[r][c+2],matrix[r][c+3],matrix[r][c+4],matrix[r][c+5],matrix[r][c+6]].map(v=>v>0?1:0);
                    if (s.join('') === '1011101') score += 40;
                }
            }
            for (let c = 0; c < size; c++) {
                for (let r = 0; r < size - 6; r++) {
                    const s = [matrix[r][c],matrix[r+1][c],matrix[r+2][c],matrix[r+3][c],matrix[r+4][c],matrix[r+5][c],matrix[r+6][c]].map(v=>v>0?1:0);
                    if (s.join('') === '1011101') score += 40;
                }
            }
            return score;
        }

        function generate(text) {
            const bytes = new TextEncoder().encode(text);
            const version = getVersion(bytes.length);
            if (version < 0) throw new Error('Data too long for QR code');

            const dataBytes = encodeData(text, version);
            const codewords = interleaveAndEC(dataBytes, version);
            const dataBits = [];
            for (const cw of codewords) for (let i = 7; i >= 0; i--) dataBits.push((cw >> i) & 1);

            let bestMatrix = null, bestScore = Infinity, bestMask = 0;
            const { size } = createMatrix(version);

            for (let mask = 0; mask < 8; mask++) {
                const { matrix, reserved, size: s } = createMatrix(version);
                placeData(matrix, reserved, s, dataBits);
                applyMask(matrix, reserved, s, mask);
                placeFormatInfo(matrix, s, mask);
                const p = penalty(matrix, s);
                if (p < bestScore) { bestScore = p; bestMatrix = matrix; bestMask = mask; }
            }

            return { matrix: bestMatrix, size };
        }

        return { generate };
    })();

    function renderQR(canvas, text, cellSize = 6) {
        const { matrix, size } = QRCode.generate(text);
        const quiet = 4;
        const total = size + quiet * 2;
        canvas.width = total * cellSize;
        canvas.height = total * cellSize;
        const ctx = canvas.getContext('2d');
        ctx.fillStyle = '#FFFFFF';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        ctx.fillStyle = '#0F172A';
        for (let r = 0; r < size; r++) {
            for (let c = 0; c < size; c++) {
                if (matrix[r][c] === 1) {
                    ctx.fillRect((c + quiet) * cellSize, (r + quiet) * cellSize, cellSize, cellSize);
                }
            }
        }
    }

    function toggleQRModal() {
        const modal = document.getElementById('qrModal');
        const overlay = document.getElementById('qrOverlay');
        const isShow = modal.classList.contains('show');
        modal.classList.toggle('show');
        overlay.classList.toggle('show');
        if (!isShow) {
            const url = window.location.href;
            const input = document.getElementById('qrInput');
            if (!input.value) input.value = url.startsWith('file:') ? '' : url;
            generateQR();
        }
    }

    function generateQR() {
        const input = document.getElementById('qrInput');
        const url = input.value.trim() || window.location.href;
        const canvas = document.getElementById('qrCanvas');
        const urlDisplay = document.getElementById('qrUrl');
        try {
            renderQR(canvas, url, 5);
            urlDisplay.textContent = url;
        } catch (e) {
            urlDisplay.textContent = 'URLÂ§™ÈïøÔºåËØ∑Áº©Áü≠ÂêéÈáçËØï';
        }
    }
    </script>
</body>
</html>
